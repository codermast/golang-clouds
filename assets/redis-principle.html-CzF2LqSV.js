import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,a as n,o as e}from"./app-EbySI1sk.js";const t={};function l(d,s){return e(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="redis-底层原理" tabindex="-1"><a class="header-anchor" href="#redis-底层原理"><span>Redis 底层原理</span></a></h1><p>数据结构、线程模型、网络模型。</p><h2 id="线程模型" tabindex="-1"><a class="header-anchor" href="#线程模型"><span>线程模型</span></a></h2><h3 id="redis-是单线程还是多线程" tabindex="-1"><a class="header-anchor" href="#redis-是单线程还是多线程"><span>Redis 是单线程还是多线程？</span></a></h3><table><thead><tr><th style="text-align:left;">版本</th><th style="text-align:left;">命令执行</th><th style="text-align:left;">其他操作</th></tr></thead><tbody><tr><td style="text-align:left;">6.0 前</td><td style="text-align:left;">单线程</td><td style="text-align:left;">持久化、删除等使用子进程</td></tr><tr><td style="text-align:left;">6.0+</td><td style="text-align:left;">单线程</td><td style="text-align:left;">网络 IO 可以多线程</td></tr></tbody></table><p><strong>核心命令执行始终是单线程！</strong></p><h3 id="为什么单线程还这么快" tabindex="-1"><a class="header-anchor" href="#为什么单线程还这么快"><span>为什么单线程还这么快？</span></a></h3><table><thead><tr><th style="text-align:left;">原因</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;">纯内存操作</td><td style="text-align:left;">微秒级响应</td></tr><tr><td style="text-align:left;">IO 多路复用</td><td style="text-align:left;">单线程处理多连接</td></tr><tr><td style="text-align:left;">高效数据结构</td><td style="text-align:left;">专门优化的数据结构</td></tr><tr><td style="text-align:left;">单线程无锁</td><td style="text-align:left;">避免上下文切换和锁竞争</td></tr></tbody></table><h3 id="redis-6-0-多线程" tabindex="-1"><a class="header-anchor" href="#redis-6-0-多线程"><span>Redis 6.0 多线程</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># redis.conf</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">io-threads</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 4</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                     # IO 线程数</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">io-threads-do-reads</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> yes</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          # 读也使用多线程</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># 多线程只用于网络 IO，命令执行仍是单线程</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>       客户端请求</span></span>
<span class="line"><span>           ↓</span></span>
<span class="line"><span>    ┌──────────────┐</span></span>
<span class="line"><span>    │  IO 多线程   │  ← 读取请求、写入响应</span></span>
<span class="line"><span>    └──────┬───────┘</span></span>
<span class="line"><span>           ↓</span></span>
<span class="line"><span>    ┌──────────────┐</span></span>
<span class="line"><span>    │  主线程执行  │  ← 命令执行（单线程）</span></span>
<span class="line"><span>    └──────────────┘</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="网络模型" tabindex="-1"><a class="header-anchor" href="#网络模型"><span>网络模型</span></a></h2><h3 id="io-多路复用" tabindex="-1"><a class="header-anchor" href="#io-多路复用"><span>IO 多路复用</span></a></h3><p>Redis 使用 IO 多路复用处理多个客户端连接。</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>         ┌─────────────────────────────────┐</span></span>
<span class="line"><span>         │          Event Loop             │</span></span>
<span class="line"><span>         │  ┌─────────────────────────┐    │</span></span>
<span class="line"><span>         │  │    epoll/kqueue/select  │    │</span></span>
<span class="line"><span>         │  └────────────┬────────────┘    │</span></span>
<span class="line"><span>         │               ↓                 │</span></span>
<span class="line"><span>         │  ┌─────────────────────────┐    │</span></span>
<span class="line"><span>         │  │      事件处理器         │    │</span></span>
<span class="line"><span>         │  │  • 连接处理器           │    │</span></span>
<span class="line"><span>         │  │  • 命令处理器           │    │</span></span>
<span class="line"><span>         │  │  • 响应处理器           │    │</span></span>
<span class="line"><span>         │  └─────────────────────────┘    │</span></span>
<span class="line"><span>         └─────────────────────────────────┘</span></span>
<span class="line"><span>                   ↑     ↑     ↑</span></span>
<span class="line"><span>               Client1 Client2 Client3</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="事件类型" tabindex="-1"><a class="header-anchor" href="#事件类型"><span>事件类型</span></a></h3><table><thead><tr><th style="text-align:left;">事件</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;">文件事件</td><td style="text-align:left;">客户端连接、读写</td></tr><tr><td style="text-align:left;">时间事件</td><td style="text-align:left;">定时任务（serverCron）</td></tr></tbody></table><h3 id="事件处理流程" tabindex="-1"><a class="header-anchor" href="#事件处理流程"><span>事件处理流程</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>1. 客户端发起连接</span></span>
<span class="line"><span>2. 触发 AE_READABLE 事件</span></span>
<span class="line"><span>3. 连接处理器创建客户端对象</span></span>
<span class="line"><span>4. 客户端发送命令</span></span>
<span class="line"><span>5. 触发 AE_READABLE 事件</span></span>
<span class="line"><span>6. 命令处理器执行命令</span></span>
<span class="line"><span>7. 触发 AE_WRITABLE 事件</span></span>
<span class="line"><span>8. 响应处理器返回结果</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="数据结构" tabindex="-1"><a class="header-anchor" href="#数据结构"><span>数据结构</span></a></h2><h3 id="底层数据结构" tabindex="-1"><a class="header-anchor" href="#底层数据结构"><span>底层数据结构</span></a></h3><table><thead><tr><th style="text-align:left;">结构</th><th style="text-align:left;">说明</th><th style="text-align:left;">用途</th></tr></thead><tbody><tr><td style="text-align:left;">SDS</td><td style="text-align:left;">简单动态字符串</td><td style="text-align:left;">String</td></tr><tr><td style="text-align:left;">IntSet</td><td style="text-align:left;">整数集合</td><td style="text-align:left;">小 Set</td></tr><tr><td style="text-align:left;">Dict</td><td style="text-align:left;">哈希表</td><td style="text-align:left;">Hash、Set、ZSet</td></tr><tr><td style="text-align:left;">ZipList</td><td style="text-align:left;">压缩列表</td><td style="text-align:left;">小 List、Hash、ZSet</td></tr><tr><td style="text-align:left;">QuickList</td><td style="text-align:left;">快速列表</td><td style="text-align:left;">List</td></tr><tr><td style="text-align:left;">SkipList</td><td style="text-align:left;">跳表</td><td style="text-align:left;">ZSet</td></tr><tr><td style="text-align:left;">Listpack</td><td style="text-align:left;">紧凑列表（Redis 7.0+）</td><td style="text-align:left;">替代 ZipList</td></tr></tbody></table><h3 id="sds-简单动态字符串" tabindex="-1"><a class="header-anchor" href="#sds-简单动态字符串"><span>SDS（简单动态字符串）</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> sdshdr {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> len;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       // 已使用长度</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> alloc;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     // 分配的空间</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    char</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> flags;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 类型标志</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    char</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> buf</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">[]</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 字符数组</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>SDS vs C 字符串：</strong></p><table><thead><tr><th style="text-align:left;">特性</th><th style="text-align:left;">C 字符串</th><th style="text-align:left;">SDS</th></tr></thead><tbody><tr><td style="text-align:left;">获取长度</td><td style="text-align:left;">O(n)</td><td style="text-align:left;">O(1)</td></tr><tr><td style="text-align:left;">缓冲区溢出</td><td style="text-align:left;">可能</td><td style="text-align:left;">不会</td></tr><tr><td style="text-align:left;">修改字符串</td><td style="text-align:left;">每次都分配</td><td style="text-align:left;">预分配 + 惰性释放</td></tr><tr><td style="text-align:left;">二进制安全</td><td style="text-align:left;">❌</td><td style="text-align:left;">✅</td></tr></tbody></table><h3 id="dict-哈希表" tabindex="-1"><a class="header-anchor" href="#dict-哈希表"><span>Dict（哈希表）</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> dict {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    dictType </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">type;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    dictEntry </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">**</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ht_table</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // 两个哈希表，用于 rehash</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    long</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> rehashidx;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">           // rehash 进度，-1 表示未进行</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} dict;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>渐进式 rehash：</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>1. 分配新哈希表 ht[1]</span></span>
<span class="line"><span>2. rehashidx = 0</span></span>
<span class="line"><span>3. 每次操作时迁移 ht[0] 的部分数据到 ht[1]</span></span>
<span class="line"><span>4. 全部迁移完成后交换 ht[0] 和 ht[1]</span></span>
<span class="line"><span>5. rehashidx = -1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ziplist-压缩列表" tabindex="-1"><a class="header-anchor" href="#ziplist-压缩列表"><span>ZipList（压缩列表）</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>┌─────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│ zlbytes │ zltail │ zllen │ entry1 │ entry2 │ zlend │</span></span>
<span class="line"><span>└─────────────────────────────────────────────────┘</span></span>
<span class="line"><span></span></span>
<span class="line"><span>entry 结构:</span></span>
<span class="line"><span>┌──────────────────┬─────────┬─────────┐</span></span>
<span class="line"><span>│ prevlen (1/5字节)│ encoding│  data   │</span></span>
<span class="line"><span>└──────────────────┴─────────┴─────────┘</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>优点：</strong> 内存紧凑<br><strong>缺点：</strong> 连锁更新风险（prevlen 从 1 字节变 5 字节）</p><h3 id="skiplist-跳表" tabindex="-1"><a class="header-anchor" href="#skiplist-跳表"><span>SkipList（跳表）</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>Level 4:  1 ────────────────────────────→ 9</span></span>
<span class="line"><span>Level 3:  1 ────────→ 5 ────────────────→ 9</span></span>
<span class="line"><span>Level 2:  1 ────→ 3 → 5 ────→ 7 ────────→ 9</span></span>
<span class="line"><span>Level 1:  1 → 2 → 3 → 4 → 5 → 6 → 7 → 8 → 9</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>特点：</strong></p><ul><li>平均查找复杂度 O(log n)</li><li>每个节点有多层指针</li><li>适合范围查询</li></ul><h3 id="数据类型与底层结构" tabindex="-1"><a class="header-anchor" href="#数据类型与底层结构"><span>数据类型与底层结构</span></a></h3><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">编码</th></tr></thead><tbody><tr><td style="text-align:left;">String</td><td style="text-align:left;">int、embstr、raw</td></tr><tr><td style="text-align:left;">List</td><td style="text-align:left;">quicklist（ziplist + 链表）</td></tr><tr><td style="text-align:left;">Hash</td><td style="text-align:left;">listpack（小）、hashtable（大）</td></tr><tr><td style="text-align:left;">Set</td><td style="text-align:left;">intset（整数）、hashtable</td></tr><tr><td style="text-align:left;">ZSet</td><td style="text-align:left;">listpack（小）、skiplist + hashtable（大）</td></tr></tbody></table><h3 id="编码转换条件" tabindex="-1"><a class="header-anchor" href="#编码转换条件"><span>编码转换条件</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="shiki" data-ext="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-bash"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Hash</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">hash-max-listpack-entries</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 512</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">hash-max-listpack-value</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 64</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># List</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">list-max-listpack-size</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> -2</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # 每个节点最大 8KB</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Set</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set-max-intset-entries</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 512</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># ZSet</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">zset-max-listpack-entries</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 128</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">zset-max-listpack-value</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 64</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="过期策略" tabindex="-1"><a class="header-anchor" href="#过期策略"><span>过期策略</span></a></h2><h3 id="删除策略" tabindex="-1"><a class="header-anchor" href="#删除策略"><span>删除策略</span></a></h3><table><thead><tr><th style="text-align:left;">策略</th><th style="text-align:left;">说明</th><th style="text-align:left;">优缺点</th></tr></thead><tbody><tr><td style="text-align:left;">惰性删除</td><td style="text-align:left;">访问时检查是否过期</td><td style="text-align:left;">内存不及时释放</td></tr><tr><td style="text-align:left;">定期删除</td><td style="text-align:left;">定时随机检查并删除</td><td style="text-align:left;">CPU 消耗</td></tr></tbody></table><p><strong>Redis 采用惰性删除 + 定期删除。</strong></p><h3 id="定期删除算法" tabindex="-1"><a class="header-anchor" href="#定期删除算法"><span>定期删除算法</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>每次执行：</span></span>
<span class="line"><span>1. 从有过期时间的 key 中随机取 20 个</span></span>
<span class="line"><span>2. 删除其中已过期的 key</span></span>
<span class="line"><span>3. 如果过期 key 超过 25%，重复步骤 1</span></span>
<span class="line"><span>4. 最多执行 25ms</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="内存管理" tabindex="-1"><a class="header-anchor" href="#内存管理"><span>内存管理</span></a></h2><h3 id="对象结构" tabindex="-1"><a class="header-anchor" href="#对象结构"><span>对象结构</span></a></h3><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-c"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">typedef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> redisObject {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    unsigned</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> type:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       // 类型（string/list/hash/set/zset）</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    unsigned</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> encoding:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">   // 编码方式</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    unsigned</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> lru:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">24</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       // LRU 时间或 LFU 计数</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> refcount;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          // 引用计数</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">ptr;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">             // 指向实际数据</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">} robj;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="内存分配" tabindex="-1"><a class="header-anchor" href="#内存分配"><span>内存分配</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>Redis 内存分配器：</span></span>
<span class="line"><span>├── jemalloc（默认，推荐）</span></span>
<span class="line"><span>├── tcmalloc</span></span>
<span class="line"><span>└── libc malloc</span></span>
<span class="line"><span></span></span>
<span class="line"><span>jemalloc 特点：</span></span>
<span class="line"><span>├── 减少内存碎片</span></span>
<span class="line"><span>├── 多线程性能好</span></span>
<span class="line"><span>└── 支持内存统计</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="共享对象" tabindex="-1"><a class="header-anchor" href="#共享对象"><span>共享对象</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>Redis 启动时创建共享对象：</span></span>
<span class="line"><span>├── 0-9999 的整数</span></span>
<span class="line"><span>├── 常用字符串（OK、ERR 等）</span></span>
<span class="line"><span>└── 空对象</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="通信协议" tabindex="-1"><a class="header-anchor" href="#通信协议"><span>通信协议</span></a></h2><h3 id="resp-协议" tabindex="-1"><a class="header-anchor" href="#resp-协议"><span>RESP 协议</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>简单字符串：+OK\\r\\n</span></span>
<span class="line"><span>错误：-ERR unknown command\\r\\n</span></span>
<span class="line"><span>整数：:1000\\r\\n</span></span>
<span class="line"><span>批量字符串：$6\\r\\nfoobar\\r\\n</span></span>
<span class="line"><span>数组：*2\\r\\n$3\\r\\nGET\\r\\n$3\\r\\nkey\\r\\n</span></span>
<span class="line"><span>空：$-1\\r\\n 或 *-1\\r\\n</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="客户端发送" tabindex="-1"><a class="header-anchor" href="#客户端发送"><span>客户端发送</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>SET key value</span></span>
<span class="line"><span>→ *3\\r\\n$3\\r\\nSET\\r\\n$3\\r\\nkey\\r\\n$5\\r\\nvalue\\r\\n</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="服务端响应" tabindex="-1"><a class="header-anchor" href="#服务端响应"><span>服务端响应</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>+OK\\r\\n           # SET 成功</span></span>
<span class="line"><span>$5\\r\\nvalue\\r\\n   # GET 返回 value</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div>`,61)])])}const r=i(t,[["render",l]]),c=JSON.parse('{"path":"/tutorials/database/redis/redis-principle.html","title":"Redis 底层原理","lang":"zh-CN","frontmatter":{"order":7,"description":"Redis 底层原理 数据结构、线程模型、网络模型。 线程模型 Redis 是单线程还是多线程？ 核心命令执行始终是单线程！ 为什么单线程还这么快？ Redis 6.0 多线程 网络模型 IO 多路复用 Redis 使用 IO 多路复用处理多个客户端连接。 事件类型 事件处理流程 数据结构 底层数据结构 SDS（简单动态字符串） SDS vs C 字符...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Redis 底层原理\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-12-12T08:44:14.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Golang Clouds\\",\\"url\\":\\"https://www.golangclouds.com\\",\\"email\\":\\"codermast@163.com\\"}]}"],["meta",{"property":"og:url","content":"https://www.golangclouds.com/tutorials/database/redis/redis-principle.html"}],["meta",{"property":"og:site_name","content":"Golang Clouds"}],["meta",{"property":"og:title","content":"Redis 底层原理"}],["meta",{"property":"og:description","content":"Redis 底层原理 数据结构、线程模型、网络模型。 线程模型 Redis 是单线程还是多线程？ 核心命令执行始终是单线程！ 为什么单线程还这么快？ Redis 6.0 多线程 网络模型 IO 多路复用 Redis 使用 IO 多路复用处理多个客户端连接。 事件类型 事件处理流程 数据结构 底层数据结构 SDS（简单动态字符串） SDS vs C 字符..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-12-12T08:44:14.000Z"}],["meta",{"property":"article:modified_time","content":"2025-12-12T08:44:14.000Z"}]]},"git":{"createdTime":1765529054000,"updatedTime":1765529054000,"contributors":[{"name":"友人","username":"","email":"codermast@qq.com","commits":1}]},"readingTime":{"minutes":3.87,"words":1160},"filePathRelative":"tutorials/database/redis/redis-principle.md","autoDesc":true}');export{r as comp,c as data};
